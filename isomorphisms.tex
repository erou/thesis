We studied in Part~\ref{part:single} the arithmetic of a single finite field
extension. We now study a set of several extensions. The very first step will be
to understand how to compute an isomorphism (or an embedding) between two finite
fields: this is the material of this chapter.
\minitoc

% TODO: figure

\clearpage

Our reference for this chapter is~\cite{BDDFS17}: although it provides a variety
of isomorphism algorithms (and their analysis), we are mainly interested in the
naive isomorphism algorithm (used in
Chapter~\ref{chap:lattice}) and in Allombert's algorithm (used in
Chapter~\ref{chap:standard}). We thus do not cover all the isomorphism
algorithms, the reader interested in Rains' algorithm~\cite{Pinch92, Rains96}
and its elliptic variant can take a look at the paper cited above.

\section{Preliminaries and naive algorithm}
\label{sec:prelim-naive-algo}

Even if our real goal is to compute \emph{embeddings} of finite fields, \ie
ring homomorphisms
\[
  \phi:K\to L
\]
with $K$ and $L$ finite fields, we often refer to the algorithms as
\emph{isomorphism} algorithms. Indeed, computing the embedding $\phi$ is
the same as computing an isomorphism
\[
  \phi':K\overset{\sim}{\to} K'
\]
of $K$ with a subfield $K'\subset L$ of $L$. The
isomorphism $\phi'$ is just the embedding $\phi$ with its codomain being
restricted to $K'$. That is why in the remainder of this chapter, we present
\emph{isomorphism} algorithms, rather than embedding algorithms.

\subsection{Description of the problem}

We let $p$ be a prime number, $\K = \mathbb{F}_p$ be the field with $p$ elements,
and $f, g\in\K[X]$ two irreducible polynomials of degree $m=\deg(f)$ and
$n=\deg(g)$, with
\[
  m\mid n.
\]
Let
\[
  K=\K[X]/(f(X))\cong\mathbb{F}_{p^m}
\]
and
\[
  L = \K[Y]/(g(Y))\cong\mathbb{F}_{p^n}
\]
be two extensions of $\K$. We know there is an embedding
\[
  \phi:K\to L,
\]
unique up to $\K$-automorphism of $K$, \ie there are
\[
  \Card\Gal(K/\K)=m
\]
different embeddings from $K$ to $L$, that can be described as
\[
  \phi\circ\sigma
\]
for $\sigma\in\Gal(K/\K)$. Equivalently, they can also be described as
\[
  \sigma'\circ\phi
\]
with $\sigma'\in\Gal(\phi(K)/\K)$. The \emph{embedding problem} is then to
efficiently find, represent and evaluate one such embedding $\phi$. 
Following~\cite{BDDFS17}, the problem is split in two parts.
\begin{description}
  \item[Embedding description problem.] Compute elements $\alpha\in K$ and
    $\beta\in L$ such that 
    \[
      K=\K(\alpha)
    \]
    and such that there exists an embedding $\phi$ mapping $\alpha$ to $\beta$.
  \item[Embedding evaluation problem.] Given elements $\alpha$ and $\beta$
    defined above, and elements $x\in K$, $y\in L$, solve the
    following problems:
    \begin{itemize}
      \item compute $\phi(x)\in L$;
      \item test if $y\in\phi(K)$;
      \item if $y\in\phi(K)$, then compute $\phi^{-1}(y)\in K$.
    \end{itemize}
\end{description}
As the name suggests, the \emph{embedding description problem} focuses on
finding a pair of elements that are sufficient to describe an embedding. Indeed,
if 
\[
  K=\K(\alpha)
\]
we know that every element $x\in K$ can be uniquely written as 
\[
  x = \sum_{j=0}^{m-1}a_j\alpha^j
\]
with $a_j\in\K$ for al $0\leq j\leq m-1$, and the embedding $\phi$ is then
defined by
\[
  \phi(x) = \sum_{j=0}^{m-1}a_j\beta^j.
\]
\begin{prop}
  \label{prop:description}
 The elements $\alpha$ and $\beta$
 describe an embedding if and only if they have the same minimal polynomial over
 $\K$. 
\end{prop}
\begin{proof}
  Let $\phi:K\to L$ be an embedding mapping $\alpha$ to $\beta$ and let 
  \[
    P = \Minpoly_\K(\alpha)
  \]
  be the the minimal polynomial of $\alpha$. Then 
  \begin{align*}
    P(\beta) &= P(\phi(\alpha)) \\
    &= \phi(P(\alpha))\\
    &= \phi(0) \\
    &= 0
  \end{align*}
  thus $\Minpoly_\K(\beta)\neq 1$ divides $P$ which is irreducible so 
  \[
\Minpoly_\K(\beta) = P.
  \]
 Conversely, if $\alpha$ and $\beta$ have the same minimal polynomial $P$, then the
 map $\phi$ is well-defined and defines an isomorphism between the fields $\K(\alpha)$ and
 $\K(\beta)$, that are both isomorphic to the field
 \[
   \K[X]/(P(X)).
 \]
\end{proof}
While the first problem focuses on finding a description of $\phi$, the
\emph{embedding evaluation problem} independently asks how to efficiently use
the description to compute the actual embedding. We target this question in
Section~\ref{sec:evaluation}.

\subsection{Embedding description problem and naive algorithm}
\label{sec:embedding-description}

Until the end of this section and in Section~\ref{sec:allombert}, we deal with
the \emph{embedding description problem}, although we only review a subpart of
the existing algorithms (see~\cite{BDDFS17} for other algorithms). As above, let
$f$ and $g$ be two irreducible polynomials with coefficients in $\K$ and with
respective degree $m$ and $n$, such that
\[
  m\mid n.
\]
Let
\[
  K=\K[X]/(f(X))\cong\mathbb{F}_{p^m}
\]
and
\[
  L = \K[Y]/(g(Y))\cong\mathbb{F}_{p^n}
\]
be two finite fields. Then one can simply take $\alpha$ to be the class of $X$ in
$K$ and choose $\beta$ to be any root of $f$ in $L$. Indeed, we know that there
is an isomorphic copy of $K$ in $L$ and thus that $f$ splits over $L$.
Furthermore, any root of $f$ will have $f$ as its minimal polynomial, which is
also the minimal polynomial of $\alpha$ by construction. By
Proposition~\ref{prop:description}, the map 
\[
  \phi:K\to L
\]
sending $\alpha$ to $\beta$ is an embedding. The critical routine in that
algorithm is to find a root of $f$ in $L$, that can be done using the
Shoup-Kaltofen \emph{equal degree factorization} algorithm~\cite{KS97}. The
complexity analysis of~\cite{BDDFS17} indicates that the cost is strictly larger
than quasi-quadratic complexity $\tilde O(m^2)$. A more efficient algorithm, due
to Lenstra and Allombert, is discussed in Section~\ref{sec:allombert}.

\section{Lenstra-Allombert algorithm}
\label{sec:allombert}

Both Lenstra~\cite{Lenstra91} and Allombert used
Kummer theory, the study of certain field extensions, to compute isomorphisms
between finite fields. But while Lenstra's focus
was on proving the existence of a deterministic isomorphism algorithm, Allombert 
wanted to provide a practical algorithm. This led to the invention of the
Lenstra-Allombert algorithm~\cite{Allombert02} in 2002, for which we give a
description in this section. The ideas of Allombert play an important part in
Chapter~\ref{chap:standard} too. The techniques based on Kummer theory work
for extensions of degree $n$ coprime to the characteristic $p$. In order to have
an algorithm working for any type of extension, the solution is to deal with the
part of the extension which degree is divisible by $p$ separately using
Artin-Shreier theory and to glue the results together in the end. More details
can be found in~\cite[Section 3.2]{BDDFS17}.

% TODO
% ====
%
% Add an entire part on Artin-Shreier instead? Probably not, since it will not
% be used at all in the rest of the thesis.

\subsection{Preliminaries}
\label{sec:preliminaries}

Let us first discuss a simpler case than the general one, that will highlight
the method behind the Lenstra-Allombert isomorphism algorithm. Let $K$ and $L$ be
two finite fields of cardinality $p^n$, such that
\[
  K\cong L\cong \mathbb{F}_{p^n}.
\]
Assume that $\gcd(p, n)=1$ and that
\[
  n\mid p-1,
\]
or equivalently that there is a primitive $n$-th root of unity in
$\K=\mathbb{F}_p$, that we denote by $\zeta$. The algorithm is based on
Proposition~\ref{prop:h90}.

\begin{prop}[Hilbert $90$ theorem]
  \label{prop:h90}
  Let $K$ be a finite extension of $\K=\mathbb{F}_p$ of degree $n$ such that there exists a
primitive $n$-th root of unity $\zeta\in\K$ in the base field $\K$, \ie such
that $n$ divides $p-1$. 
 Let $\sigma$ be the Frobenius automorphism of the extension
 \[
   K/\K
 \]
 and consider the following equation in $K$.
 \begin{equation}
   \tag{H90}
   \sigma(x) = \zeta x
   \label{eq:h90}
 \end{equation}
The solutions of~\eqref{eq:h90} form a one dimensional $\K$-vector space and if
$\alpha\in K$ is such a solution, we have
\[
  \alpha^n\in\K.
\]
If $\alpha$ is also nonzero, then it is a generator of $K$ over $\K$.
\end{prop}
\begin{proof}
  Let us first construct a nonzero solution of~\eqref{eq:h90}. Consider the polynomial
  \[
    P = \sum_{j=0}^{n-1}\zeta^{-j} X^{p^j}
  \]
  of degree $p^{n-1}$. The polynomial $P$ has at most $p^{n-1}$ roots in $K$,
  which has cardinality $p^n$, so there exists some element $x\in K$ such that
  \[
    y = P(x)\neq0.
  \]
  Now, by construction, we have
  \begin{align*}
    \sigma(y) &= \sigma(\sum_{j=0}^{n-1}\zeta^{-j}x^{\sigma^{j}})\\
    &= \sum_{j=0}^{n-1}\zeta^{-j}x^{\sigma^{j+1}}\\
    &= \zeta \times \sum_{j=0}^{n-1}\zeta^{-(j+1)}x^{\sigma^{j+1}}\\
    &= \zeta \times \sum_{j=1}^{n}\zeta^{-j}x^{\sigma^{j}}\\
    &= \zeta y
  \end{align*}
  and thus $y$ is a nonzero solution of~\eqref{eq:h90}. All the elements
  \[
    \lambda y
  \]
  with $\lambda\in\K$ are also solutions of~\eqref{eq:h90} since
  \[
    \sigma(\lambda y) = \lambda\sigma(y) = \zeta\lambda y,
  \]
  and the equation has at most $p$ solutions because the polynomial
  \[
    X^p - \zeta X
  \]
  has at most $p$ roots in $K$. Thus there are exactly $p$ different solutions,
  that are the elements of $\Vect(y)$. Let $z$ be a solution of~\eqref{eq:h90},
  then we have
  \begin{align*}
   \sigma(z^n) &= \sigma(z)^n\\
   &= (\zeta z)^n\\
   &= z^n,
  \end{align*}
  therefore $z^n$ is fixed by $\sigma$, which means that
  \[
    z^n\in\K.
  \]
  If $z$ is also nonzero, then for all $0\leq j<n$, we have
  \begin{align*}
    \sigma^j(z) &= \underbrace{(\sigma\circ\dots\circ\sigma)}_{j\text{ times}}(z)\\
    &= \underbrace{(\sigma\circ\dots\circ\sigma)}_{j-1\text{ times}}(\zeta z)\\
    &= \zeta\underbrace{(\sigma\circ\dots\circ\sigma)}_{j-1\text{ times}}(z)\\
    &= \zeta^j z\\
    &\neq z.
  \end{align*}
  Consequently, $z$ is not in any subfield of $K$ and is thus a generator of $K$
  over $\K$.
\end{proof}
Note that Proposition~\ref{prop:h90} applies both to the fields $K$ and $L$,
therefore we can solve Equation~\eqref{eq:h90} in both fields. Let $\alpha_K$ be a
solution of Equation~\eqref{eq:h90} for the root $\zeta$ in $K$, and $\alpha_L$
a solution in $L$. Since we want the primitive $n$-th root of unity $\zeta$ to
be the same in $K$ and $L$, we assume that we already have an embedding from
$\K$ in both these fields. In practice, since $\K$ is a
prime field and the fields $K$ and $L$ are represented by polynomials over
$\K = \mathbb{F}_p=\mathbb{Z}/p\mathbb{Z}$, the assumption is not really
hard to meet. Let
\[
  a_K = \alpha_K^n
\]
and
\[
  a_L = \alpha_L^n.
\]
By Proposition~\ref{prop:h90}, we know that $a_K$ and $a_L$ are both in $\K$ and
this can be used to compute an isomorphism between $K$ and $L$.
\begin{prop}[Allombert~{\cite{Allombert02}}]
  \label{prop:allombert-simple}
 The quotient
 \[
   a_K/a_L
 \]
 is an $n$-th power in $\K$, and if
 \[
   c^n = a_K/a_L
 \]
 then the map sending $\alpha_K$ to $c\alpha_L$ is an isomorphism from $K$ to $L$.
\end{prop}
\begin{proof}
  Let $\phi:K\to L$ be a $\K$-isomorphism between $K$ and $L$. We have
  \begin{align*}
    \sigma(\phi(\alpha_K)) &= \phi(\alpha_K)^p\\
    &= \phi(\alpha_K^p)\\
    &= \phi(\sigma(\alpha_K))\\
    &= \phi(\zeta\alpha_K)\\
    &= \zeta\phi(\alpha_K)
  \end{align*}
  thus $\phi(\alpha_K)$ is a solution of~\eqref{eq:h90} and by
  Proposition~\ref{prop:h90} there exists $\lambda\in\K$ such that
  \[
    \phi(\alpha_K) = \lambda\alpha_L.
  \]
  We also have
  \[
    \phi(\alpha_K)^n = \phi(\alpha_K^n) = \phi(a_K) = a_K,
  \]
  therefore the quotient
  \begin{align*}
    a_K/a_L &= \phi(\alpha_K)^n/\alpha_L^n\\
    &= \lambda^{n}
  \end{align*}
  is an $n$-th power in $\K$. Now let $c\in\K$ be any $n$-th root of $a_K/a_L$,
  then
  \[
    c = \zeta^j\lambda
  \]
  for some $0\leq j\leq n-1$, that is $c$ and $\lambda$ differ by a $n$-th root
  of unity, and so do $\phi(\alpha_K)$ and $c\alpha_L$:
  \[
    c\alpha_L = \zeta^j\phi(\alpha_K) = \sigma^j(\phi(\alpha_K)).
  \]
  Finally, the elements $c\alpha_L$ and $\phi(\alpha_K)$ have the same minimal
  polynomial, because they are conjugates, and $\phi(\alpha_K)$ has the same
  minimal polynomial as $\alpha_K$ because $\phi$ is an isomorphism, so by
  Proposition~\ref{prop:description}, the map sending $\alpha_K$ to $c\alpha_L$ is an
  isomorphism from $K$ to $L$.
\end{proof}
In this simpler case ($n$ divides $p-1$), Lenstra-Allombert algorithm consists
in
\begin{enumerate}
  \item finding $\alpha_K\in K$ and $\alpha_L\in L$ with
    $\sigma(\alpha_K)=\zeta\alpha_K$ and $\sigma(\alpha_L)=\zeta\alpha_L$;
  \item computing a $n$-th root $c$ of $\alpha_K^n/\alpha_L^n$;
  \item returning the isomorphism described by $\alpha_K\mapsto c\alpha_L$.
\end{enumerate}

\paragraph{General case.} When $n\nmid p-1$, which is always
the case asymptotically since we work with $p$ fixed and we let $n$ grow, there
are no $n$-th roots of unity in $\K$, and the strategy of
Section~\ref{sec:preliminaries} cannot be applied as if. Nevertheless, it is
still possible to apply a similar idea by extending the space so that it
contains artificial roots of unity.

\subsection{Kummer algebras}
\label{sec:kummer-algebras}

% TODO
% ====
%
% Fix the definitions by saying something about where do we pick the roots of
% unity from. Algebraic closure ? Doesn't that make some of the results trivial or
% something? 

Instead of ``just'' working in $\mathbb{F}_{p^n}$, we work in
\[
  A_n = \mathbb{F}_{p^n}\otimes \mathbb{F}_p(\zeta),
\]
where $\zeta$ is a primitive $n$-th root of unity, and where $\otimes$ is the tensor
product over $\K=\mathbb{F}_p$. We thus extend the scalars and force the existence of
suitable roots of unity. The $\K$-algebra $A_n$ can now be used instead of
$\mathbb{F}_{p^n}$ in the Lenstra-Allombert algorithm. Following the terminology
of~\cite{DRR19}, we call these algebras \emph{Kummer algebras}.

\begin{defi}[Kummer algebra]
  Let $p\in\mathbb{N}$ a prime number and $\K=\mathbb{F}_p$ the finite field
  with $p$ elements.
 We call the $\K$-algebra
 \[
   A_n = \mathbb{F}_{p^n}\otimes\mathbb{F}_{p}(\zeta),
 \]
 where $\otimes$ is the tensor product over $\K$, a \emph{Kummer algebra of
 degree $n$}.
\end{defi}
\begin{defi}[Field of scalars]
  Let $A_n$ be a Kummer algebra of degree $n$. Then we define
  $\mathbb{F}_{p}(\zeta)$ as the \emph{field of scalars} of $A_n$, and we
  define the \emph{level} $\nu(n)$ of $A_n$ as
  \[
    \nu(n) = \mathrm{ord}_{(\mathbb{Z}/n\mathbb{Z})^\times}(p) = \left[
      \mathbb{F}_{p}(\zeta):\K \right],
  \]
  that is the degree of its field of scalars.
\end{defi}
Let $\sigma:x\mapsto x^p$ be the Frobenius automorphism of the extension
\[
  \mathbb{F}_{p^n}/\K,
\]
and extend it to $A_n$ by defining the linear map
\[
  \begin{array}{cccc}
    \sigma\otimes 1: & A_n & \to & A_n\\
    & \sum_j x_j\otimes y_j & \mapsto & \sum_j \sigma(x_j) \otimes y_j.
  \end{array}
\]
The map $\sigma\otimes 1$ will play the role of $\sigma$ in the simpler case.
\begin{lm}
  The map $\sigma\otimes1$ is a $1\otimes\mathbb{F}_{p}(\zeta)$-linear
  endomorphism with $n$ distinct eigenvalues, that are the powers of
  $1\otimes\zeta$.
\end{lm}
\begin{proof}
  Because of the linear independence of characters~\cite[Chapter VI,
  §4]{Lang04}, we know that the automorphisms
  \[
    \Id, \sigma, \sigma^2, \dots, \sigma^{n-1}
  \]
  are independent. We also know that 
  \[
    \sigma^n = \Id,
  \]
  therefore the minimal polynomial of the $\K$-linear endomorphism $\sigma$ is
  \[
    X^n-1.
  \]
  By the Cayley-Hamilton theorem, we deduce that the characteristic
  polynomial of $\sigma$ is also $X^n-1$. Now let $\B=\left\{ b_1, \dots, b_n \right\}$ be a basis of
  $\mathbb{F}_{p^n}/\K$ and let $M$ be the matrix of $\sigma$ in this basis.
  Then the matrix of the $1\otimes\mathbb{F}_p(\zeta)$-linear endomorphism
  $\sigma\otimes1$ in the basis
  \[
    \B\otimes 1 =\left\{ b_1\otimes1, \dots, b_n\otimes1 \right\}
  \]
  is also $M$. Thus, the characteristic polynomial of $\sigma\otimes1$ is again
  $X^n-1$, that splits completely in 
  \[
    1\otimes\mathbb{F}_{p}(\zeta)\cong \mathbb{F}_{p}(\zeta),
  \]
  the roots being the elements
  \[
    1\otimes\zeta^j
  \]
  for $0\leq j\leq n-1$. Finally, the eigenvalues are the roots of the
  characteristic polynomial so this concludes the proof.
\end{proof}
Since there are exactly $n$ distinct eigenvalues, we know that the
corresponding eigenspaces are all one-dimensional
$1\otimes\mathbb{F}_{p}(\zeta)$-vector spaces, and the eigenspace corresponding
to the eigenvalue $\zeta$ is described by the equation
 \begin{equation}
   \tag{H90}
   (\sigma\otimes1)(x) = (1\otimes\zeta) x
   \label{eq:h90-kummer}
 \end{equation}
 that we again denote by~\eqref{eq:h90-kummer}. The field of scalars of $A_n$ now
 plays the role of the base field $\K$ in the simpler case and the solutions
 of~\eqref{eq:h90-kummer} have similar properties.
 \begin{lm}
   \label{lm:fixed-elems}
   The set of elements in $A_n$ fixed by $\sigma\otimes1$ is
   \[
     1\otimes\mathbb{F}_{p}(\zeta)\cong \mathbb{F}_{p}(\zeta),
   \]
   a subfield isomorphic to the field of scalars of $A_n$.
 \end{lm}
 \begin{proof}
   Let 
   \[
     \B = \left\{ b_1, \dots, b_a \right\}
   \]
   be a basis of
   \[
     \mathbb{F}_p(\zeta)/\K.
   \]
   Then, every element $\alpha$ in $A_n$ can be uniquely written in the form
   \[
     \alpha = \sum_{j=1}^a x_j\otimes b_j
   \]
   where for all $1\leq j\leq a$, $x_j\in\mathbb{F}_{p^n}$. If 
   \begin{align*}
     \sum_{j=1}^a\sigma(x_j)\otimes b_j &= (\sigma\otimes1)(\alpha)\\
     &= \alpha
   \end{align*}
 it follows that for all $1\leq j\leq a$, we have
   \[
     \sigma(x_j) = x_j
   \]
   and thus we have $x_j\in\K$. Consequently, the element $\alpha$ belongs to
   the set
   \[
     \K\otimes\mathbb{F}_{p}(\zeta) =
     1\otimes\mathbb{F}_p(\zeta)\cong\mathbb{F}_p(\zeta).
   \]
   Conversely, if an element $\alpha$ is in $1\otimes\mathbb{F}_{p}(\zeta)$,
   then it is fixed by $\sigma\otimes1$.
 \end{proof}
 \begin{rem}
   \label{rem:fixed-elems}
   We can use the proof of Lemma~\ref{lm:fixed-elems} (modulo appropriate
   changes) in order to prove that the set of elements in $A_n$ fixed by
   $1\otimes\sigma'$, with $\sigma'$ the Frobenius automorphism of the extension
   $\mathbb{F}_{p}(\zeta)/\K$, is $\mathbb{F}_{p^n}\otimes1$. In the remainder
   of the document, we write $\sigma$ for both $\sigma$ and $\sigma'$.
 \end{rem}
 \begin{lm}
   \label{lm:h90-solutions}
   Let $\alpha$ be a nonzero solution of~\eqref{eq:h90-kummer} for the root
   $\zeta$. Then 
   \[
     \alpha^n\in 1\otimes\mathbb{F}_{p}(\zeta)
   \]
   and $\alpha$ is a generating element for $A_n$ as an algebra over
   $1\otimes\mathbb{F}_{p}(\zeta)$ that is also invertible.
 \end{lm}
 \begin{proof}
  We have
  \begin{align*}
    (\sigma\otimes1)(\alpha^n) &= (\sigma\otimes1)(\alpha)^n\\
    &= ((1\otimes\zeta)\alpha)^n\\
    &= (1\otimes\zeta^n)\alpha^n\\
    &= \alpha^n,
  \end{align*}
  thus $\alpha^n\in1\otimes\mathbb{F}_p(\zeta)$ by Lemma~\ref{lm:fixed-elems}.
  Since $\alpha$ is a solution of~\eqref{eq:h90-kummer} for $\zeta$, then
  for every $1\leq j\leq n-1$, $\alpha^j$ is a solution for $\zeta^j$, indeed
  \begin{align*}
    (\sigma\otimes 1)(\alpha^j) &= ( (\sigma\otimes1)(\alpha))^j\\
    &= (1\otimes\zeta^j)\alpha^j.
  \end{align*}
  Then, the elements $1, \alpha, \dots, \alpha^{n-1}$ are eigenvectors for
  distinct eigenvalues of $\sigma\otimes1$ and thus form a basis of $A_n$ over
  $1\otimes \mathbb{F}_{p}(\zeta)$. Assume that $\alpha^n=1\otimes c$ for some
  $c\in\mathbb{F}_{p}(\zeta)$. There are no nonzero nilpotent elements in $A_n$;
  one way of seeing it is to say that
  \[
    A_n \cong \mathbb{F}_{p}(\zeta)[T]/(h(T))
  \]
  where $h$ is the irreducible polynomial defining
  \[
    \mathbb{F}_{p^n} = \K[X]/(h(X)).
  \]
  Since the degree $n$ of
  $h$ is not a multiple of $p$, the polynomial $h$ is separable and 
  \[
    \mathbb{F}_{p^n}[T]/(h(T))
  \]
  has no nonzero nilpotent elements. Then $\alpha^n$ is nonzero thus
  $c\in\mathbb{F}_p(\zeta)$ is also nonzero. It follows that $\alpha$ is
  invertible, indeed
  \[
    \alpha^{-1} = (1\otimes c^{-1})\alpha^{n-1}.
  \]
 \end{proof}
 \begin{defi}[Kummer constant]
   Let $\alpha\in A_n$ be a nonzero solution of~\eqref{eq:h90-kummer} for the
   root $\zeta$. The constant $c\in\mathbb{F}_p(\zeta)$ such that
   \[
     \alpha^n = 1\otimes c
   \]
   is called the \emph{Kummer constant} of $\alpha$.
 \end{defi}
 One key property of the solutions of~\eqref{eq:h90-kummer} is still missing,
 and we need a new notation to express it. Let $K$ and $L$ be two finite field
 extensions of $\K$ and let $\mu\in L$ be an element of degree $d$ over $\K$. As
 used several times already, we know that an element 
 \[
   \beta\in K\otimes \K(\mu)\subset K\otimes L 
 \]
   can be uniquely written as
 \[
   \beta=\sum_{j=0}^{d-1}x_j\otimes\mu^j,
 \]
 and we set
 \[
   \first{\beta}{\mu} = x_0.
 \]
 \begin{prop}[{\cite[Proposition 3.6]{Allombert02}}]
   \label{prop:generate}
   Let $\alpha$ be a nonzero solution of~\eqref{eq:h90-kummer} for the root
   $\zeta$, then
   \[
     \first{\alpha}{\zeta}
   \]
   is a generating element of the extension
   \[
     \mathbb{F}_{p^n}/\K.
   \]
 \end{prop}
 \begin{proof}
   Let $r=\left[ \mathbb{F}_{p}(\zeta):\K \right]$ and
   \[
     P = X^r - \sum_{j=0}^{r-1}z_j X^j
   \]
   the minimal polynomial of $\zeta$ over $\K$. Let also
   \[
     \alpha = \sum_{j=0}^{r-1}a_j\otimes\zeta^j.
   \]
   It follows that 
   \begin{align*}
     \sum_{j=0}^{r-1}\sigma(a_j)\otimes\zeta^j &=(\sigma\otimes1)(\alpha)\\
     &= (1\otimes\zeta)\alpha\\
     &= \sum_{j=0}^{r-1}a_j\otimes\zeta^{j+1}\\
     &= \sum_{j=0}^{r-2}a_j\otimes\zeta^{j+1} +
     a_{r-1}\otimes(\sum_{i=0}^{r-1}z_i\zeta^i)\\
     &= a_{r-1}z_0\otimes 1 +
     \sum_{j=1}^{r-1}(a_{j-1}+a_{r-1}z_j)\otimes\zeta^j,
   \end{align*}
   we thus have
   \[
   \left\{ 
     \begin{array}{l}
       \sigma(a_0) = a_{r-1}z_0 \\
       \sigma(a_j) = a_{j-1}+a_{r-1}z_j\text{ for all }1\leq j\leq r-1.
     \end{array}
   \right.
 \]
 With these equations, we will prove that
 \[
   \mathbb{F}_p(a_0) = \mathbb{F}_{p^n},
 \]
 thus concluding the proof. We have $\sigma(a_0)\in\mathbb{F}_p(a_0)$ and
 $z_0\in\K$. Since $z_0$ is nonzero, we have that
 \[
   a_{r-1} = \sigma(a_0)z_0^{-1}\in\mathbb{F}_p(a_0).
 \]
 Going from $j=r-1$ down to $1$, it also follows that
 $a_{j-1}\in\mathbb{F}_{p}(a_0)$. Now assume that $e\in\mathbb{N}$ is an integer
 such that
 \[
   \sigma^e(x) = x
 \]
 for all $x\in\mathbb{F}_p(a_0)$, and such that $e<n$, \ie
 \[
   \mathbb{F}_p(a_0)\subsetneq \mathbb{F}_{p^n}.
 \]
 Since all the $a_j$ are in $\mathbb{F}_{p}(a_0)$, we also have
 \begin{align*}
  (1\otimes\zeta^e)\alpha &= (\sigma\otimes1)^e(\alpha)\\
  &= (\sigma^e\otimes1)(\alpha)\\
  &= \alpha
 \end{align*}
 and thus $\zeta^e=1$, which is a contradiction since $\zeta$ is a primitive
 $n$-th root of unity and $e<n$. Therefore we must have $e=n$ and
 $\mathbb{F}_p(a_0) = \mathbb{F}_{p^n}$.
 \end{proof}
 \begin{rem}
   \label{rem:recover-alpha}
 With the equations 
    \[
   \left\{ 
     \begin{array}{l}
       \sigma(a_0) = a_{r-1}z_0 \\
       \sigma(a_j) = a_{j-1}+a_{r-1}z_j\text{ for all }1\leq j\leq r-1
     \end{array}
   \right.
 \]
 found in the proof of Proposition~\ref{prop:generate}, we note that we can in
 fact also recover $\alpha$ from $\first{\alpha}{\zeta}$.
 \end{rem}
Similarly to the case where $n\mid p-1$, where the solutions
$\alpha\in\mathbb{F}_{p^n}$ of~\eqref{eq:h90} directly generate $\mathbb{F}_{p^n}$, we now know
that the solutions $\alpha\in A_n$ of~\eqref{eq:h90-kummer} in the general case
can also be used to generate $\mathbb{F}_{p^n}$ through $\first{\alpha}{\zeta}$.
We can study these solutions a bit further: in fact the element
$\first{\alpha}{\zeta}$ essentially depends on $\alpha^n$, rather than on
$\alpha$.
\begin{prop}
  \label{prop:kummer-constant}
  Let
  \[
    \alpha=\sum_{j=0}^{r-1}a_j\otimes\zeta^j\in A_n
  \]
  be a nonzero solution of~\eqref{eq:h90-kummer} for $\zeta$ and
  let $\alpha^n = 1\otimes c$. There are exactly $n$ elements $x\in A_n$ that
  are solutions of~\eqref{eq:h90-kummer} for $\zeta$ and such that
  \[
    x^n = 1\otimes c.
  \]
  These elements are the
  \[
    (1\otimes\zeta^u)\alpha = (\sigma^u\otimes1)(\alpha)
  \]
  for $0\leq u\leq n-1$. The corresponding generating elements of
  $\mathbb{F}_{p^n}/\K$ are the
  \[
    \first{(\sigma^u\otimes1)(\alpha)}{\zeta} = \sigma^u(a_0);
  \]
  they all have the same minimal polynomial, which is an irreducible polynomial
  defining $\mathbb{F}_{p^n}/\K$ that only depends on the Kummer constant
  $c\in\mathbb{F}_{p}(\zeta)$.
\end{prop}
\begin{proof}
  The solutions of~\eqref{eq:h90-kummer} form a one-dimensional
  $1\otimes\mathbb{F}_p(\zeta)$-vector space, so all solutions are of the form
  \[
    x = (1\otimes\lambda)\alpha
  \]
  with $\lambda\in\mathbb{F}_p(\zeta)$.
  Since we also ask for $x^n = \alpha^n$, we must have $\lambda^n = 1$ and thus 
  \[
    \lambda = \zeta^u
  \]
  for some $0\leq u\leq r-1$. Conversely all the solutions of the form
  $x=(1\otimes\zeta^u)$ verify $x^n=\alpha^n$. Therefore, if $x$ is such an
  element, we have
  \begin{align*}
    x &= (\sigma^u\otimes1)(\alpha)\\
    &= \sum_{j=0}^{r-1}\sigma^u(a_j)\otimes\zeta^j,
  \end{align*}
  thus
  \[
    \first{x}{\zeta} = \sigma^u(a_0).
  \]
  All these elements are conjugates, thus share the same minimal polynomial,
  that is known to define $\mathbb{F}_{p^n}/\K$ by
  Proposition~\ref{prop:generate} and that depends only on the constant
  $c\in\mathbb{F}_p(\zeta)$.
\end{proof}

\subsection{The isomorphism algorithm}
\label{sec:lenstra-allombert-isomorphism}

Let $p\in\mathbb{N}$ a prime number and $n\in\mathbb{N}$ be an integer such that
$\gcd(n, p)=1$. Let $K$ and $L$ be two finite fields of cardinality $p^n$, such
that
\[
  K\cong L\cong \mathbb{F}_{p^n}.
\]
Let $\zeta$ be a primitive $n$-th root of unity. In this section, we show how to
construct a single isomorphism between $K$ and $L$, using the results of
Section~\ref{sec:kummer-algebras}. How to construct embeddings
between extensions of different degrees, and how to deal with a lattice of
embeddings, is discussed in~Chapter~\ref{chap:standard}, together with
additionnal results on Kummer algebras. We let
\[
  A_K = K\otimes\mathbb{F}_p(\zeta)
\]
and
\[
  A_L = L\otimes\mathbb{F}_{p}(\zeta)
\]
be the two Kummer algebras constructed with $K$ and $L$ and with the same field of
scalars $\mathbb{F}_{p}(\zeta)$. The next proposition is the generalization of
Proposition~\ref{prop:allombert-simple}.
\begin{prop}
  \label{prop:lenstra-allombert-algorithm}
 Let $\alpha_K\in A_K$ (respectively $\alpha_L\in A_L$) be a nonzero solution
 of~\eqref{eq:h90-kummer} for the root $\zeta$ in the Kummer algebra $A_K$
 (resp. $A_L$) and let $c_K\in\mathbb{F}_{p}(\zeta)$ (resp.
 $c_L\in\mathbb{F}_p(\zeta)$) the Kummer constant of $\alpha_K$
 (resp. $\alpha_L$). The quotient
 \[
   c_K/c_L
 \]
 is a $n$-th power in $\mathbb{F}_p(\zeta)$, and if
 \[
   \kappa^n = c_K/c_L
 \]
 then the map sending $\first{\alpha_K}{\zeta}$ to
 $\first{(1\otimes\kappa)\alpha_L}{\zeta}$ is an isomorphism from $K$ to $L$.
\end{prop}
\begin{proof}
  The proof is very similar to the one of
  Proposition~\ref{prop:allombert-simple}. Let
  \[
    \phi:K\to L
  \]
  be an isomorphism from $K$ to $L$. Then $\phi\otimes1$ is a morphism of
  algebras from $A_K$ to $A_L$ and
  \[
    (\phi\otimes1)(\alpha_K)
  \]
  is a solution of~\eqref{eq:h90-kummer} for $\zeta$ in $A_L$. Therefore
  there exist $\lambda\in\mathbb{F}_p(\zeta)$ such that
  \[
    (\phi\otimes1)(\alpha_K) = \lambda\alpha_L.
  \]
  The Kummer constant of $(\phi\otimes1)(\alpha_K)$ is still $c_K$, and we have
  \[
    c_K/c_L = \lambda^n.
  \]
  Hence, if $\kappa$ is an $n$-th root of $c_K/c_L$, we have
  \[
    ((1\otimes\kappa)\alpha_L)^n = c_K,
  \]
  \ie the elements $\alpha_K$ and $(1\otimes\kappa)\alpha_L$ share the same
  Kummer constant. By Proposition~\ref{prop:kummer-constant}, the elements
  $\first{\alpha_K}{\zeta}$ and $\first{(1\otimes\kappa)\alpha_L}{\zeta}$ have
  the same minimal polynomial and thus describe an isomorphism from $K$ to $L$
  by Proposition~\ref{prop:description}.
\end{proof}
Finally, Lenstra-Allombert algorithm, in the general case, consists in
\begin{enumerate}
  \item finding $\alpha_K\in K\otimes\mathbb{F}_p(\zeta)$ such that
    \[
      (\sigma\otimes1)(\alpha_K)=(1\otimes\zeta)\alpha_K
    \]
    and $\alpha_L\in L\otimes\mathbb{F}_p(\zeta)$ such that
    \[
      (\sigma\otimes1)(\alpha_L)=(1\otimes\zeta)\alpha_L;
    \]
  \item computing an $n$-th root $\kappa\in\mathbb{F}_p(\zeta)$ of the quotient
    $\alpha_K^n/\alpha_L^n$;
  \item returning the isomorphism described by
    $\first{\alpha_K}{\zeta}\mapsto\first{(1\otimes\kappa)\alpha_L}{\zeta}$.
\end{enumerate}
The computational cost of Lenstra-Allombert algorithm resides in the computation
of~\eqref{eq:h90-kummer} solutions, \ie Step $1$ of the previous list.

\subsection{Computing~\eqref{eq:h90-kummer} solutions}
\label{sec:computing-h90}

In this section, we briefly present the different known solutions to
compute~\eqref{eq:h90-kummer} solutions, details can be found in~\cite{BDDFS17}.
Allombert first proposed to use linear
algebra. The idea is to compute the matrix $M$ of the Frobenius automorphism
$\sigma$ of $\mathbb{F}_{p^n}/\K$, that is the same as the matrix of
$\sigma\otimes1$, and then to compute an eigenvector of $M$ over
\[
  1\otimes\mathbb{F}_{p}(\zeta) \cong \mathbb{F}_{p}(\zeta)
\]
for the eigenvalue
\[
  1\otimes\zeta\cong\zeta.
\]
Allombert later revised his algorithm~\cite{Allombert02, Allombert02-rev}:
instead of directly using linear algebra over
$\mathbb{F}_{p}(\zeta)$, we can use the factorization
\[
  P(X) = (X-\zeta)b(X)
\]
where $P$ is the minimal polynomial of $\zeta$ over $\K$. If we write 
\[
  P = X^r + \sum_{j=0}^{r-1}z_jX^j,
\]
we can check that
\[
  b(X) = \sum_{j=0}^{r-1}b_j(X)\zeta^j,\text{ where}
  \left\{ 
    \begin{array}{l}
      b_{r-1}(X) = 1,\\
      b_{j-1}(X) = b_j(X) X + z_j\text{ for all } 0\leq j\leq r-1.
    \end{array}
  \right.
\]
Indeed, direct computation shows that
\[
  (X-\zeta)b(X) = b_0(X)X+z_0  = b_{-1}(X)
\]
and Horner 's rule also shows that
\[
  b_{-1}(X) = P(X).
\]
We then get a solution of~\eqref{eq:h90-kummer} by evaluating $b(X)$ at an
element in the kernel of 
\[
  P(\sigma)=(\sigma-\zeta\Id)\circ b(\sigma),
\]
hence we still use linear algebra, but
over $\K=\mathbb{F}_p$ instead of $\mathbb{F}_{p}(\zeta)$ this time. A different
strategy follows from the fact that if $x\in\mathbb{F}_{p^n}$, then
\[
  \alpha_x=\sum_{j=0}^{n-1}\sigma^j(x)\otimes\zeta^{-j-1}
\]
verifies
\[
  (\sigma\otimes1)(\alpha_x) = (1\otimes\zeta)\alpha_x.
\]
This is also a consequence of the factorization
\begin{align*}
  X^n-1 &= (X-\zeta)\sum_{j=0}^{n-1}\zeta^{-j-1}X^j\\
  &= (X-\zeta)\Theta(X).
\end{align*}
The question is now whether the solution $\alpha_x$ is nonzero. By the theorem
on character independence~\cite[Chapter VI, §4]{Lang04} the maps
$1, \sigma, \sigma^2, \dots, \sigma^{n-1}$, all distinct, are independent.
Therefore, the $\K$-linear map
\[
  x\mapsto\alpha_x
\]
cannot be indentically zero on $\mathbb{F}_{p^n}$ and has rank at least $1$. A
random $\alpha_x$ thus has a probability of being zero less than $1/p$, so we
need $O(1)$ trials to find a nonzero $\alpha_x$ at random. Depending on the
relative size of $p$, $n$, and $s=\left[ \mathbb{F}_p(\zeta):\K \right]$, the
computational cost of finding a nonzero $\alpha_x$ is discussed in details
in~\cite{BDDFS17} and is bounded by $O(M(n^2)\log(n)+M(n)\log(p))$. If
$\omega=3$, where $\omega$ is the exponent of matrix
multiplication, then the cost is at best quadratic in $n$.

\section{The embedding evaluation problem}
\label{sec:evaluation}

Let us first recall the problem. Let $\K=\mathbb{F}_p$ the prime field with $p$
elements, where $p\in\mathbb{N}$ is a prime number, and let $K$ and $L$ be
two finite extensions of $\K$. Let $m=\left[ K:\K \right]$ and $n = \left[ L:\K
\right]$ be the respective degrees of the extensions $K/\K$ and $L/\K$ and
assume that
\[
  m\mid n.
\]
Let $\alpha\in K$ and $\beta\in L$ be two elements such that the $\K$-linear map
\[
  \phi:\alpha\mapsto\beta
\]
sending $\alpha$ to $\beta$ describes an embedding from $K$ to $L$. The
\emph{embedding evaluation problem} consists in three sub-goals: given $\alpha$
and $\beta$ defined above and elements $\gamma\in K$, $\delta\in L$:
\begin{itemize}
  \item compute $\phi(\gamma)\in L$;
  \item test if $\delta\in\phi(K)$;
  \item if $\delta\in\phi(K)$, then compute $\phi^{-1}(\delta)\in K$.
\end{itemize}
In this section too, we follow the presentation of~\cite{BDDFS17} and we develop
three solutions constructed on top of each other.

\subsection{Linear algebra}
\label{sec:linalg}

Until the end of the section, we assume that the elements in $K$ are represented
on the monomial basis
\[
  (1, X, \dots, X^{m-1})
\]
and the elements in $L$ are represented on the monomial basis
\[
  (1, Y, \dots, Y^{n-1}).
\]
We are particularly interested in the $\K$-vector space structure of $K$ and
$L$ and in order to emphasize which basis is used, we let
\[
  V_X
\]
be the vector space $K$ equipped with the basis $(1, X, \dots, X^{m-1})$ and
\[
  V_Y
\]
be the vector space $L$ equipped with the basis $(1, Y, \dots, Y^{n-1})$.
Similarly, we let 
\[
  V_\alpha
\]
be the vector space $K$ equipped with the basis $(1, \alpha, \dots,
\alpha^{m-1})$ and
\[
  V_\beta
\]
be the subspace $V_\beta\subset L$ equipped with the basis $(1, \beta, \dots,
\beta^{m-1})$, that is isomorphic to $V_\alpha$.
Since the map $\phi$ is $\K$-linear, we can store the $n\times m$ matrix representing $\phi$
in the monomial bases and evaluate $\phi$ via a matrix-vector product. We know
that $\phi$ maps $\alpha$ to $\beta$, hence we write $\phi$ as the composition
of three maps
\[
  V_X \overset{\sim}{\longrightarrow} V_\alpha \overset{\sim}{\longrightarrow}
  V_\beta \longhookrightarrow V_Y.
\]
First, we apply a change of basis from $V_X$ to $V_\alpha$. Then we apply the
isomorphism from $V_\alpha$ to $V_\beta$, that is represented by the
identity matrix. Finally we write the obtained element, expressed in $(1,
\beta, \dots, \beta^{m-1})$, in the
monomial basis of $L$, \ie we embed $V_\beta$ in $V_Y$. The map
$V_\beta\hookrightarrow V_Y$ is represented by an $n\times m$ matrix whose
columns are the vectors $(\beta^j)_{0\leq j\leq m-1}$ expressed in the monomial
basis of $L$. The inverse of this map is obtained by solving a linear system.
Similarly, the map $V_X\overset{\sim}{\to}V_\alpha$ is represented
by the $m\times m$ matrix whose columns are the vectors $(X^j)_{0\leq j\leq
m-1}$ expressed in the basis $(1, \alpha, \dots, \alpha^{m-1})$, that is also
the inverse of the matrix whose columns are the vectors $(\alpha^j)_{0\leq j\leq
m-1}$ expressed in the monomial basis of $K$. The cost of the evaluation of
$\phi$ and its inverse is thus dominated by the solving of the linear system,
that is $O(m^{\omega-1}n)$. This cost can be reduced to $O(mn)$ with some
precomputation, \eg an LU decomposition, but the biggest drawback of the linear
algebra approach is the memory complexity rather than the time complexity.
Indeed, storing the matrices requires $O(mn)$ elements in $\K$.

\subsection{Inverse maps and duality}
\label{sec:duality}

The first improvement to the linear algebra method consists in replacing the
linear system solving used in the computation of the inverse of
\[
  V_\beta\emb V_Y
\]
by simpler operations, such as matrix-vector product, in order to reduce the
overall complexity. We first recall facts about bilinear forms and duality, the
presentation follows the one in~\cite{BDDFS17} and~\cite{DDS14}, and a standard
presentation is also available in~\cite{Lang04}. Recall that
\[
  K\cong\mathbb{F}_{p^m}
\]
admits a monomial basis $(1, X, \dots, X^{m-1})$ and that
\[
  L\cong\mathbb{F}_{p^n}
\]
admits a monomial basis $(1, Y, \dots, Y^{n-1})$. The trace $\tr_{K/\K}$ from $K$ to
$\K$ defines a non-degenerate bilinear form denoted by
\[
  \ps{x}{y}_K = \tr_{K/\K}(xy).
\]
Therefore, we can define a \emph{dual basis} $(X_0^*, X_1^*, \dots, X_{m-1}^*)$
to $(1, X, \dots, X^{m-1})$, characterized by
\[
  \ps{X^j}{X_i^*}=\left\{\begin{array}{l}
    1\text{ if }i=j\\
    0\text{ otherwise.}
  \end{array}\right.
\]
Similarly, we can define a non-degenerate bilinear form from $L$ to $\K$ by
\[
  \ps{x}{y}_L = \tr_{L/\K}(xy),
\]
and a dual basis $(Y_0^*, \dots, Y_{n-1}^*)$ to $(1, \dots, Y^{n-1})$
corresponding to this bilinear form. Now, let
\[
  \psi:K\emb L
\]
be an embedding. It is a $\K$-linear map and thus there exists a unique
\emph{dual map} $\psi^t$, such that
\[
  \ps{\psi(x)}{y}_L = \ps{x}{\psi^t(y)}_K
\]
for all $x\in K$ and $y\in L$. Furthermore, if $M$ is the matrix representing
$\psi$ in the monomial bases of $K$ and $L$, then its transposed matrix $M^t$
represents the map $\psi^t$ in the \emph{dual bases}. This allows us to
efficiently compute $\psi^t$, because the conversions from the monomial basis to
the dual basis of
$\mathbb{F}_{p^m}$ can be done at a cost of $O(M(m)\log(m))$ operations in $\K$,
as explained in~\cite{DDS14}. Fortunately, the map $\psi^t$, that is easy to
compute, is closely related to $\psi^{-1}$, the map that we want. In particular, if
$K\cong L$ and $\psi$ is an isomorphism of fields, we have that $\psi^t$ is
exaclty $\psi^{-1}$. Indeed, in that case, the map $\psi$ preserves the bilinear
form, \ie for all $x, y\in K$, we have
\[
  \ps{\psi(x)}{\psi(y)}_L = \ps{x}{y}_K.
\]
We thus have
\[
  \ps{x}{(\psi^t\circ\psi)(y)}_K = \ps{x}{y}_K,
\]
and it follows that $\psi^t\circ\psi$ is the identity map, because the bilinear
form is non-degenerate. Now if $K$ and $L$ are not isomorphic, \ie $m<n$, we can
still use $\psi^t$ to recover $\psi^{-1}$. Let 
\[
  d = [L:K] = \frac{n}{m}
\]
and
\[
  x\in \psi(K)\subsetneq L,
\]
we have
\begin{align*}
  \tr_{L/\K}(x) &= \sum_{j=0}^{n-1}\sigma^i(x) \\
  &= \sum_{i=0}^{d-1}\sum_{j=0}^{m-1}\sigma^{im+j}(x)\\
  &= \sum_{i=0}^{d-1}\sum_{j=0}^{m-1}\sigma^{j}(x)\\
  &= \sum_{i=0}^{d-1}\tr_{\psi(K)/\K}(x)
\end{align*}
and thus it follows that
\[
  \tr_{L/\K}(x) = d\tr_{\psi(K)/\K}(x).
\]
Hence, in that case, the map $\psi$ does not preserve the bilinear form, but we
still have
\[
  \ps{\psi(x)}{\psi(y)}_L = d\ps{x}{y}_K
\]
for all $x, y\in K$. If $d$ is not a multiple of the characteristic $p$, then
the map $d^{-1}\psi^t$ is the inverse of $\psi$, by the same argument as before.
Otherwise, let $x\in\psi(K)\subsetneq L$ and let $u\in L$ an element such that
\[
  \tr_{L/\psi(K)}(u)=1.
\]
Then, by transitivity of the trace, and by
$\psi(K)$-linearity of the trace $\tr_{L/\psi(K)}$, it follows that
\begin{align*}
  \tr_{L/\K}(ux) &= \tr_{\psi(K)/\K}(\tr_{L/\psi(K)}(ux)) \\
  &= \tr_{\psi(K)/\K}(x\tr_{L/\psi(K)}(u)) \\
  &= \tr_{\psi(K)/\K}(x).
\end{align*}
Therefore we have
\begin{align*}
  \ps{x}{y}_K &= \tr_{K/\K}(xy) \\
  &= \tr_{\psi(K)/\K}(\psi(x)\psi(y)) \\
  &= \tr_{L/\K}(u\psi(x)\psi(y))\\
  &= \ps{\psi(x)}{u\psi(y)}_L,
\end{align*}
and if we let $U$ the map defined by $z\mapsto uz$, we conclude that
\[
  \psi^t\circ U\circ\psi=\psi^t\circ U^t\circ\psi
\]
is the identity map, and we can once again compute $\psi^{-1}$. Let us go back
to our original problem: we want to compute the embedding
\[
  \phi:K\to L
\]
that is described by $\phi(\alpha) = \beta$. Recall that we can decompose $\phi$
into three maps
\[
  V_X \overset{\sim}{\longrightarrow} V_\alpha \overset{\sim}{\longrightarrow}
  V_\beta \longhookrightarrow V_Y,
\]
and that we want to be able to compute both $\phi$ and its inverse
$\phi^{-1}$. The map $V_\alpha\overset{\sim}{\to}V_\beta$ is represented by the
identity matrix, thus it is straighforward to compute. The map
$V_\alpha\overset{\sim}{\to}V_X$ (the inverse of
$V_X\overset{\sim}{\to}V_\alpha$) is represented, in the monomial bases of
$V_\alpha$ and $V_X$, by the matrix whose columns are the vectors
$(\alpha^j)_{0\leq j \leq m-1}$ in the monomial basis of $K$. The map
$V_\beta\emb V_Y$ is similarly represented by the vectors
$(\beta^{j})_{1\leq j\leq m-1}$ in the monomial basis of $L$. Both these
maps are embeddings, thus we can compute their inverse using duality
theory instead of solving linear systems like described in
Section~\ref{sec:linalg}. The inverse of $V_\beta\emb V_Y$ is evaluated by
multiplying by a fixed element $u$ that has a trace equal to $1$, then the
result is converted in the dual basis of $V_Y$, a matrix-vector product with the
transposed matrix of $V_\beta\emb V_Y$ is computed, and the product is then
converted back to the monomial basis of $V_Y$. The inverse of the embedding
$V_\alpha\overset{\sim}{\to}V_X$ is obtained similarly, but without the need to
multiply by an element $u$, because the embedding is actually an isomorphism in
that case.

It is possible to apply these steps on every element in $V_Y$, although
$\phi^{-1}$ is defined only on the image of $\phi$, \ie the subfield
\[
  \phi(K)\subset L.
\]
If the element we apply our steps to is not in $\phi(K)$, we just obtain an
arbitrary projection in $K$. Indeed, if $x\in K$ and $y\in L$, we can decompose
$y$ as
\begin{align*}
  y &= y - \tr_{L/K}(uy) + \tr_{L/K}(uy)\\
  &= y' + \tr_{L/K}(uy),
\end{align*}
where $u\in L$ is an element such that $\tr_{L/K}(u)=1$ and
$y'=y-\tr_{L/K}(uy)$. Then we have
\begin{align*}
  \ps{\phi(x)}{uy'}_L &= \tr_{L/\K}(\phi(x)uy')\\
  &= \tr_{K/\K}(\tr_{L/K}(\phi(x)uy'))\\
  &= \tr_{K/\K}(\tr_{L/K}(\phi(x)u(y-\tr_{L/K}(uy))))\\
  &=
  \tr_{K/\K}(\tr_{L/K}(\phi(x)uy))-\tr_{K/\K}(\tr_{L/K}(\phi(x)u\tr_{L/K}(uy)))\\
  &= \tr_{K/\K}(x\tr_{L/K}(uy))-\tr_{K/\K}(x\tr_{L/K}(uy)\tr_{L/K}(u))\\
  &= \tr_{K/\K}(x\tr_{L/K}(uy))-\tr_{K/\K}(x\tr_{L/K}(uy))\\
  &= 0,
\end{align*}
therefore
\begin{align*}
  \ps{\phi(x)}{uy}_L &= \ps{\phi(x)}{uy'}_L+\ps{\phi(x)}{u\tr_{L/K}(uy)}_L\\
  &= \ps{\phi(x)}{u\tr_{L/K}(uy)}_L\\
  &= \ps{x}{\tr_{L/K}(uy)}_K,
\end{align*}
that means that applying our solution on $y$ results in the element
$\tr_{L/K}(uy)$ in $V_\beta$, which coincides with $y$ if $y$ is in the subfield
$\phi(K)\subset L$. In order to test if an element $y$ is in $\phi(K)$, the best
way is then to project $y$ to $z = \tr_{L/K}(uy)$, and then check that
\[
  \phi(z) = y.
\]
After precomputation of the matrices, the most expensive operation is the
matrix-vector product, that costs $O(mn)$ operations in $\K$. It is thus better
than the cost of solving a linear system. Nevertheless, the problem of the memory
complexity remains.

\subsection{Modular composition}
\label{sec:modular-composition}

In order to tackle the memory complexity problem, we can replace the matrix
computations by modular compositions, a technique initiated by
Shoup~\cite{Shoup94, Shoup95, Shoup99}. Indeed, the computation of the embedding
\[
  V_\beta\emb V_Y
\]
is precisely a modular composition computation: we want to express a polynomial
\[
  \gamma = \sum_{j=0}^{m-1}c_j\beta^j,
\]
representing an element in $V_\beta$, into the monomial basis $(1, \dots,
Y^{n-1})$, given the polynomial expression of $\beta$ in $V_Y$
\[
  \beta = \sum_{j=0}^{n-1}b_j Y_j.
\]
If $g$ is the polynomial defining $L$ over $\K$, \ie
\[
  L \cong \K[Y]/(g(Y)),
\]
then the computation of $V_\beta\emb V_Y$ is exactly the modular composition
\[
  \gamma(\beta(Y))\mod g(Y),
\]
and this can be done efficiently by a dedicated algorithm~\cite{KU08}.
%TODO: ref to Section 1 also?
In order to compute the inverse of $V_\beta\emb V_Y$, we cannot use the same
algorithm, since this is not a modular composition problem, but we use a
generalization of the duality results of Section~\ref{sec:duality} called the
\emph{transposition principle}. This technique, also known as \emph{Tellengen's
principle}~\cite{BLS03, DeFeo10, DS10}, allows one to \emph{transpose} an
algorithm used to compute a linear map into a new algorithm that computes the
transposed linear map, without changing the complexity of the algorithm. We can
use the transposition principle with the modular composition, since the map
\[
  \gamma\to\gamma(\beta)\mod g
\]
is linear. The dual problem to modular composition was called \emph{power
projection} by Shoup, who popularized the transposition principle. It takes as
inputs the polynomials $\beta,g\in\K[Y]$, and an element $\gamma^\vee$ in
$\K[Y]^\vee$, the dual space of $\K[Y]$, \ie the space of linear forms on
$\K[Y]$. Its output is the list of elements
\[
  \gamma^\vee(1),\gamma^\vee(\beta),\gamma^\vee(\beta^2), \dots, \gamma^\vee(\beta^{n-1})
\]
in $\K$. Thanks to the transposition, the power projection problem can be solved
within the same complexity bound as modular composition. Finally, the inverse of
the embedding $\phi:V_\beta\emb V_Y$ is computed by
Algorithm~\ref{algo:inverse-embedding}.
\begin{algorithm}
  \caption{Inverse embedding}
  \label{algo:inverse-embedding}
  \begin{algorithmic}[1]
    \Require{An element $y\in L$, and two precomputed values: an element
      $\beta\in L$ generating a subfield isomorphic to $K$ and an element $u\in
      L$ such that $\tr_{L/K}(u)=1$.}
    \Ensure{The element $\tr_{L/K}(uy)$ written in the basis $(1, \beta, \dots,
    \beta^{m-1})$.}
    \State\label{line:minpoly} Compute the minimal polynomial of $\beta$ over $\K$;
    \State compute $y'=uy$;
    \State convert $y'$ to the dual basis $(Y_0^*, \dots, Y_{n-1}^*)$;
    \State compute $z = \tr_{L/K}(y')$ using \emph{power projections};
    \State convert $z$ to the monomial basis $(1, \beta, \dots, \beta^{m-1})$;
    \State \Return $z$.
  \end{algorithmic}
\end{algorithm}
This algorithm takes $y\in L$ and computes
$\tr_{L/K}(uy)$, where $u$ is still an element of relative trace equal to one:
\[
  \tr_{L/K}(u)=1.
\]
As discussed in Section~\ref{sec:duality}, this is also the result of applying
\[
  \phi^t\circ U = \phi^{-1}
\]
to $y$, where $U:y\to uy$ is the multiplication-by-$u$ map. When $y$ is in the
subfield $\phi(K)\subsetneq L$, we obtain the element
\[
  \tr_{L/K}(uy) = y
\]
expressed in the basis $(1, \dots, \beta^{m-1})$. Since the trace is computed
using power projection, rather than by a transposed matrix-vector product, this
solves the quadratic memory complexity issue. The minimal polynomial of $\beta$,
computed in Line~\ref{line:minpoly}, is required to perform conversions
between the monomial and the dual basis generated by $\beta$. It is computed
with $O(M(n)\log(n))$ operations, using the Berlekamp-Massey algorithm.
Conversions are then also computed with $O(M(n)\log(n))$ operations with the
algorithms in~\cite{DDS14}. Finally, the power projection costs $O(n^{(\omega
+1)/2})$ operations with one of the algorithms in~\cite{Shoup95, KU08}, thus
the total complexity of Algorithm~\ref{algo:inverse-embedding} is
$O(n^{(\omega+1)/2})$. We have yet to see how to compute the element $u\in L$.
If
\[
  d = [L:K]
\]
is not divisible by the characteristic $p$ of $\K$, then $d^{-1}$ is such an element.
Otherwise we can take any element whose trace is nonzero and divide it by its
trace to have an element whose trace is exactly equal to $1$. To obtain an
element whose trace is nonzero, we take random elements and compute
their trace: a number of $O(1)$ trials is expected until a suitable element is
found. Computing one trace can be done using
$O(n^{(\omega+1)/2}\log(n)+M(n)\log(p))$ operations, thus the computation of $u$ has
a cost of $O(n^{(\omega+1)/2}\log(n)+M(n)\log(p))$. To conclude, after this
precomputation, all the sub-problems of the \emph{embedding evaluation problem}
can be solved using $O(n^{(\omega+1)/2})$ operations in $\K$.
% TODO: Ref to preliminaries?

%
